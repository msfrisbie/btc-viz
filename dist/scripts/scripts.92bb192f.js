"use strict";angular.module("blockchainMonitorApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","pusher-angular","restangular","blockchainMonitorApp.services.blockchain","blockchainMonitorApp.services.bitstamp"]).config(["$routeProvider","$resourceProvider",function(a,b){b.defaults.stripTrailingSlashes=!1,a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/ticker",{templateUrl:"views/ticker.html",controller:"TickerCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("blockchainMonitorApp").controller("MainCtrl",["$scope","$timeout","Blockchain","Bitstamp",function(a,b,c,d){function e(a){if(!a)return[];var b=angular.element(a||document.getElementsByTagName("body")),c=b.data(),d=[];return angular.forEach([c.$scope,c.$isolateScope,c.$isolateScopeNoTemplate],function(a){a&&(d=d.concat(a.$$watchers||[]))}),angular.forEach(b.children(),function(a){d=d.concat(e(a))}),d}function f(b){a.orderBook=h(b),d.getRTOrderBookDiff(g)}function g(b){b=h(b),k(b),j(b.bids,a.orderBook.bids),j(b.asks,a.orderBook.asks);for(var c=0;c<b.bids.length;c++)b.bids.length<10&&a.bidTrackData.buffer.push(b.bids[c].price),a.bidTrackData.last20.push(b.bids[c].price),a.bidTrackData.last20.length>20&&a.bidTrackData.last20.pop(0);for(var c=0;c<b.asks.length;c++)b.asks.length<10&&a.askTrackData.buffer.push(b.asks[c].price),a.askTrackData.last20.push(b.asks[c].price),a.askTrackData.last20.length>20&&a.askTrackData.last20.pop(0);a.activeBidCount=a.orderBook.bids.filter(function(a){return a.quantity>0}).length,a.activeAskCount=a.orderBook.asks.filter(function(a){return a.quantity>0}).length}function h(a){return a.bids=a.bids.map(i),a.asks=a.asks.reverse().map(i),a}function i(a){return{price:parseFloat(a[0]),quantity:parseFloat(a[1]),lastUpdated:new Date}}function j(a,b){for(var c=0;c<a.length;c++){for(var d=a[c],e=!1,f=0;f<b.length;f++){var g=b[f];if(g.price===d.price){g.quantity=d.quantity,g.lastUpdated=d.lastUpdated,e=!0;break}if(g.price<d.price){b.splice(f,0,d),e=!0;break}}!e&&d.quantity>0&&b.push(d)}}function k(b){for(a.newPairs.splice(0,0,b);a.newPairs.length>15;)a.newPairs.pop()}function l(){b(function(){a.watchDensity=e($(".ask-bid")[0]).length,a.watchDensity||l()},1e3)}a.bidTrackData={last20:[200],buffer:[]},a.askTrackData={last20:[200],buffer:[]},a.updateWatchCount=function(){a.globalWatchCount=e(document)},a.newPairs=[],l(),d.getOrderBook(f)}]),angular.module("blockchainMonitorApp").controller("TickerCtrl",["$scope","Bitstamp","Blockchain",function(a,b,c){c.getTicker(function(a){console.log("mydata",a)})}]),angular.module("blockchainMonitorApp.services.blockchain",[]).factory("Blockchain",["$q","$rootScope",function(){var a={},b=new WebSocket("wss://ws.blockchain.info/inv");return b.onopen=function(){console.log("Socket has been opened!"),b.send(angular.toJson({op:"unconfirmed_sub"}))},a.getTicker=function(a){b.onmessage=function(b){a(JSON.parse(b.data))}},a}]),angular.module("blockchainMonitorApp.services.bitstamp",[]).factory("Bitstamp",["$pusher","$http","$resource",function(a,b){function c(a){b.get("/bitstamp").success(a)}function d(a){h.bind("data",a)}function e(a){i.bind("trade",a)}var f=new Pusher("de504dc5763aeef9ff52"),g=a(f),h=g.subscribe("diff_order_book"),i=g.subscribe("live_trades");return{getOrderBook:c,getRTOrderBookDiff:d,getTicker:e}}]),angular.module("blockchainMonitorApp").directive("slidingGraph",function(){return{restrict:"A",scope:{trackData:"="},link:function(a,b){function c(){e=d3.scale.linear().domain([1,m-2]).range([0,p]),f=d3.scale.linear().domain([k-20,l+20]).range([q,0]),g=d3.svg.line().interpolate("basis").x(function(a,b){return e(b)}).y(function(a){return f(a)}),h&&h.selectAll("*").remove(),h=d3.select(b[0]).attr("width",p+o.left+o.right).attr("height",q+o.top+o.bottom).append("g").attr("transform","translate("+o.left+","+o.top+")"),h.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",p).attr("height",q),h.append("g").attr("class","y axis").call(d3.svg.axis().scale(f).orient("left")),i=h.append("g").attr("clip-path","url(#clip)").append("path").datum(n).attr("class","line").attr("d",g)}function d(){var b=parseFloat(a.trackData.buffer.pop(0));if(console.log(b),a.trackData.last20.length>0){for(var f=0,h=0;h<a.trackData.last20.length;h++)f+=a.trackData.last20[h];j=f/parseFloat(a.trackData.last20.length)}for(var m=n[0],o=n[0],h=0;h<n.length;h++)n[h]<m?m=n[h]:n[h]>o&&(o=n[h]);(m!=k||o!=l)&&(l=o,k=m,c()),n.push(b?b:n[n.length-1]),i.attr("d",g).attr("transform",null).transition().duration(200).ease("linear").attr("transform","translate("+e(0)+",0)").each("end",d),n.shift()}var e,f,g,h,i,j,k=200,l=300,m=100,n=d3.range(m).map(function(){return 200}),o={top:20,right:20,bottom:20,left:40},p=500-o.left-o.right,q=300-o.top-o.bottom;c(),d()}}});